---
title: "Figure 2 analyses with a more conservative sampling threshold"
output: html_document
date: "2026-01-30"
---

In our main text analyses, we restrict our data to bins that have abundance greater than or equal to 5. In this script, we confirm that our results are robust to even a much more conservative sampling threshold of 20. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.width = 10)
```


```{r}
library(tidyverse)
library(FAVA)
library(patchwork)
library(broom)

data_pal = PNWColors::pnw_palette("Bay", 3) %>% `names<-`(c("ecogroup", "morphogroup", "species"))

```

```{r}
triton <- data.table::fread("../Data_raw/Data_Triton_v2_Maike_compressed/Triton_Binned_Trimmed.csv")

# triton = triton %>% filter(pal.lat <=65, pal.lat>=-65)

ecogroup <- data.table::fread("../Data_raw/Data_Triton_v2_Maike_compressed/Ecogroup.csv")
```


# Summarize the data in bins 5 million years wide and 5 degress latitude wide

```{r 5 degree/million year bins}
count_threshold = 20

# Make a table of species counts for each age_bin/lat_bin combo
species_abundances_5my_5deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  transmute(species, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(-76, seq(-70,80,5), 88)), 
            abundance)  %>%
  group_by(age_bin, lat_bin, species) %>%
  summarise(abundance = sum(abundance)) %>%
  pivot_wider(names_from = species, 
              values_from = abundance, 
              values_fill = 0) %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))

# Remove the 15 age/lat combos with counts < 5
species_abundances_5my_5deg = species_abundances_5my_5deg[rowSums(species_abundances_5my_5deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
species_relab_5my_5deg = species_abundances_5my_5deg
species_relab_5my_5deg[,-c(1:6)] = species_abundances_5my_5deg[,-c(1:6)] /rowSums(species_abundances_5my_5deg[,-c(1:6)])



sampling_effort = species_abundances_5my_5deg[,c(1:6)] %>% 
  data.frame %>%
  mutate(total_abundance = rowSums(species_abundances_5my_5deg[,-c(1:6)]),
         age_bin = factor(age_bin, ordered = TRUE, levels = levels(species_abundances_5my_5deg$age_bin) %>% rev))


# Make a table of ecogroup counts for each age_bin/lat_bin combo
ecogroup_abundances_5my_5deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  left_join(ecogroup) %>%
  transmute(ecogroup = `Ecogroup(s)`, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(-76, seq(-70,80,5), 88)), 
            abundance)  %>%
  group_by(age_bin, lat_bin, ecogroup) %>%
  summarise(abundance = sum(abundance)) %>%
  filter(ecogroup !="") %>%
  pivot_wider(names_from = ecogroup, 
              values_from = abundance, 
              values_fill = 0)  %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))


# Remove the 15 age/lat combos with counts < 5
ecogroup_abundances_5my_5deg = ecogroup_abundances_5my_5deg[rowSums(ecogroup_abundances_5my_5deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
ecogroup_relab_5my_5deg = ecogroup_abundances_5my_5deg
ecogroup_relab_5my_5deg[,-c(1:6)] = ecogroup_abundances_5my_5deg[,-c(1:6)] /rowSums(ecogroup_abundances_5my_5deg[,-c(1:6)])




# Make a table of morphogroup counts for each age_bin/lat_bin combo
morphogroup_abundances_5my_5deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  left_join(ecogroup) %>%
  transmute(morphogroup = Morphogroup, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(-76, seq(-70,80,5), 88)), 
            abundance)  %>%
  group_by(age_bin, lat_bin, morphogroup) %>%
  summarise(abundance = sum(abundance)) %>%
  filter(morphogroup !="") %>%
  pivot_wider(names_from = morphogroup, 
              values_from = abundance, 
              values_fill = 0) %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))


# Remove the 15 age/lat combos with counts < 5
morphogroup_abundances_5my_5deg = morphogroup_abundances_5my_5deg[rowSums(morphogroup_abundances_5my_5deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
morphogroup_relab_5my_5deg = morphogroup_abundances_5my_5deg
morphogroup_relab_5my_5deg[,-c(1:6)] = morphogroup_abundances_5my_5deg[,-c(1:6)] /rowSums(morphogroup_abundances_5my_5deg[,-c(1:6)])
```



## SPATIAL HETEROGENEITY

This analysis computes FAVA in sliding windows five samples wide within each panel of Figure 1a. 

```{r}
species_lat.windows = FAVA::window_fava(relab_matrix = species_relab_5my_5deg,
                                        window_size = 5,
                                        K = 335,
                                        group = "age_bin",
                                        time = "lat_lower")

ecogroup_lat.windows = FAVA::window_fava(relab_matrix = ecogroup_relab_5my_5deg,
                                         window_size = 5,
                                         K = 18,
                                         group = "age_bin",
                                         time = "lat_lower")

morphogroup_lat.windows = FAVA::window_fava(relab_matrix = morphogroup_relab_5my_5deg,
                                            window_size = 5,
                                            K = 19,
                                            group = "age_bin",
                                            time = "lat_lower")

lat.windows_all = morphogroup_lat.windows$window_data %>%
  transmute(age_bin = group,window_index, lat_lower = w1, morphogroup = FAVA, w1, w2, w3, w4, w5) %>% 
  left_join(ecogroup_lat.windows$window_data %>% 
              transmute( age_bin = group, window_index, lat_lower = w1, ecogroup = FAVA, w1, w2, w3, w4, w5)) %>% 
  left_join(species_lat.windows$window_data %>% 
              transmute( age_bin = group,  window_index, lat_lower = w1, species = FAVA, w1, w2, w3, w4, w5)) %>% 
  # pivot_longer(cols = c(w1, w2, w3, w4, w5), values_to = "pal.lat", names_to = "window_bound" ) %>%
  pivot_longer(cols = c(morphogroup, ecogroup, species), 
               names_to = "data", values_to = "FAVA") %>% 
  left_join(species_relab_5my_5deg %>% select(age_bin, age_lower, age_upper, lat_bin, lat_lower, lat_upper) %>%
              distinct) %>% 
  transmute(window_index, w1, w2, w3, w4, w5, lat_bin, lat_lower, lat_upper, 
            age_bin = factor(age_bin, ordered = TRUE, levels = levels(species_abundances_5my_5deg$age_bin) %>% rev), 
            age_lower, age_upper, data, FAVA) 

lat.windows_all = lat.windows_all %>%
  mutate(age_bin_label = paste0("[", - lat.windows_all$age_upper, ", ",
                                - lat.windows_all$age_lower, ")") %>% 
           factor(ordered = TRUE, 
                  levels = unique(paste0("[", - lat.windows_all$age_upper, ", ",
                                         - lat.windows_all$age_lower, ")"))))

discrete_time_pal = viridis::cividis(n = 13, direction = -1) %>% `names<-`(unique(lat.windows_all$age_bin) %>% rev)
```

## Compute diversity for each sample
```{r}
diversity = cbind(ecogroup_relab_5my_5deg[,c(1:6)],
                  ecogroup = apply(ecogroup_relab_5my_5deg[,-c(1:6)], 1, function(row) 1-sum(row^2)),
                  morphogroup = apply(morphogroup_relab_5my_5deg[,-c(1:6)], 1, function(row) 1-sum(row^2)),
                  species = apply(species_relab_5my_5deg[,-c(1:6)], 1, function(row) 1-sum(row^2)))
diversity = diversity %>% data.frame %>%
  mutate(age_bin = factor(age_bin, ordered = TRUE, levels = levels(species_abundances_5my_5deg$age_bin) %>% rev),
         age_bin_label = paste0("[", - diversity$age_upper, ", ",
                                - diversity$age_lower, ")") %>% 
           factor(ordered = TRUE, 
                  levels = unique(paste0("[", - diversity$age_upper, ", ",
                                         - diversity$age_lower, ")")) %>% rev) , .after = age_bin)

diversity_long = diversity %>% pivot_longer(cols = c(ecogroup, morphogroup, species), 
                                            names_to = "data", values_to = "diversity")


mean_diversity_long = lat.windows_all %>% 
  select(c(window_index, w1, w2, w3, w4, w5, age_bin_label)) %>% 
  distinct() %>% 
  pivot_longer(cols = w1:w5, names_to = "window", values_to = "lat_lower") %>% 
  left_join(diversity) %>% 
  left_join(sampling_effort) %>%
  group_by(age_bin_label, window_index) %>% 
  summarize(across(c(ecogroup, morphogroup, species, mean_total_abundance = total_abundance), mean)) %>% 
  pivot_longer(cols = c(ecogroup, morphogroup, species), names_to = "data", values_to = "diversity") %>% 
  left_join(select(lat.windows_all, age_bin_label, window_index, lat_lower, data, FAVA))

```

```{r}
lat.windows_all_div = lat.windows_all %>%
  left_join(diversity_long) %>%
  # add sampling effort
  left_join(sampling_effort)

((ggplot(lat.windows_all_div, aes(x = total_abundance, y = diversity, color = data)) + 
    geom_vline(xintercept = count_threshold) +
    geom_point(alpha=0.5) +
    facet_grid(data~.) +
    theme_bw() + 
    scale_x_log10() +
    ylab("Gini-Simpson diversity") +
    xlab("Total abundance in sample") + 
    scale_color_manual(values = data_pal, guide = "none") + 
    ggpubr::stat_cor(label.y = 0.9, color = "black") + 
    ylim(0,1))|
    
    (ggplot(mean_diversity_long, aes(x = mean_total_abundance, y = diversity, color = data)) + 
       geom_point(alpha=0.5) +
       facet_grid(data~.) +
       theme_bw() + 
       scale_x_log10() +
       ylab("Mean Gini-Simpson diversity in window") +
       xlab("Mean sample abundance in window") + 
       scale_color_manual(values = data_pal, guide = "none") + 
       ggpubr::stat_cor(label.y = 0.9, color = "black")+ 
       ylim(0,1))| 
    
    (ggplot(mean_diversity_long, aes(x = mean_total_abundance, y = FAVA, color = data)) + 
       geom_point(alpha=0.5) + 
       theme_bw() + 
       facet_grid(data~.) +
       scale_x_log10()  +
       xlab("Mean sample abundance in window")+
       scale_color_manual(values = data_pal, guide = "none")) + 
    ggpubr::stat_cor(label.y = 0.35, color = "black")+ 
    ylim(0,0.4)) + 
  plot_annotation(tag_levels = "A")

species_abundances_5my_5deg[,c(1:6)] %>% 
  data.frame %>%
  mutate(total_abundance = rowSums(species_abundances_5my_5deg[,-c(1:6)]))

design <- matrix(c(1, 2, 3, 4, 5,
                   6, 7, 8, 9, NA,
                   10, 11, 12, 13, NA), byrow=T, ncol = 5)


div_panels = ggplot(diversity_long, aes(x = lat_lower, y=diversity, color = data)) + 
  geom_point(alpha = 0.8) +
  geom_line(alpha = 0.8) + 
  theme_bw() + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  scale_color_manual(values = data_pal) + 
  xlab("Paleolatitude") + 
  ylab("Gini-Simpson diversity")

div_panels_mean = ggplot(mean_diversity_long, aes(x = lat_lower, y=diversity, color = data)) + 
  geom_point(alpha = 0.8) +
  geom_line(alpha = 0.8) + 
  theme_bw() + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  scale_color_manual(values = data_pal) + 
  xlab("Paleolatitude") + 
  ylab("Mean Gini-Simpson diversity in 5-degree sliding window") + 
  ylim(0,1)



fava_panels = ggplot(mean_diversity_long, aes(x = lat_lower, y=FAVA, color = data)) + 
  geom_point(alpha = 0.8) +
  geom_line(alpha = 0.8) + 
  theme_bw() + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  scale_color_manual(values = data_pal) + 
  xlab("Paleolatitude") + 
  ylab("Spatial FAVA")

ggplot(lat.windows_all_div, aes(x = lat_lower, y=total_abundance)) + 
  geom_point(alpha = 0.8) +
  geom_line(alpha = 0.8) + 
  theme_bw() + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  xlab("Paleolatitude") + 
  ylab("Total abundance") + 
  scale_y_log10(limits = c(1, 10^6))

ggplot(mean_diversity_long, aes(x = diversity, y=FAVA, color = data, fill = data)) + 
  geom_point(alpha = 0.8) +
  theme_bw() + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  scale_color_manual(values = data_pal) + 
  scale_fill_manual(values = data_pal) + 
  ylab("Spatial FAVA") + 
  xlab("Gini-Simpson diversity") + 
  stat_smooth(method = "lm")

ggplot(lat.windows_all_div, aes(x = diversity, y=FAVA)) + 
  geom_point(aes(color = lat_lower), alpha = 0.8) +
  theme_bw() + 
  facet_wrap(~ data) +
  ylab("Spatial FAVA") + 
  xlab("Gini-Simpson diversity") + 
  stat_smooth(method = "lm", color = "black") + 
  ggpubr::stat_cor(label.y.npc = 1) +
  scale_color_gradientn(colors = RColorBrewer::brewer.pal(11, "Spectral"), 
                        limits = c(-65,65), 
                        name = "Paleo\nlatitude")

ggplot(mean_diversity_long, aes(x = diversity, y=FAVA)) + 
  geom_point(aes(color = lat_lower), alpha = 0.8) +
  theme_bw() + 
  facet_wrap(~ data) +
  ylab("Spatial FAVA") + 
  xlab("Mean Gini-Simpson diversity in 5-degree sliding window") +
  stat_smooth(method = "lm", color = "black") + 
  ggpubr::stat_cor(label.y.npc = 1) +
  scale_color_gradientn(colors = RColorBrewer::brewer.pal(11, "Spectral"), 
                        limits = c(-76,76), 
                        name = "Paleo\nlatitude")

cor.test(filter(mean_diversity_long, data == "ecogroup")$FAVA,
         filter(mean_diversity_long, data == "ecogroup")$diversity, method="spearman")
cor.test(filter(mean_diversity_long, data == "morphogroup")$FAVA,
         filter(mean_diversity_long, data == "morphogroup")$diversity, method="spearman")
cor.test(filter(mean_diversity_long, data == "species")$FAVA,
         filter(mean_diversity_long, data == "species")$diversity, method="spearman")


wrap_plots(div_panels, div_panels_mean, fava_panels, guides = "collect", ncol = 3) + plot_annotation(tag_levels = "A")

div_panels
```


```{r}

lat_cat_pal = RColorBrewer::brewer.pal(n = 11, name = "Spectral")[c(1,6,9)] %>% `names<-`(c("Southern", "Equatorial", "Northern"))

t = 30
latcat = lat.windows_all %>%
  mutate(lat_cat = ifelse(w1 < -t, "Southern", 
                          ifelse(w5>t, "Northern", "Equatorial")) %>%
           factor(ordered = TRUE, levels = c("Southern", "Equatorial", "Northern")),
         age_cat = cut(age_upper, c(0, 20, 40, 66)) %>% factor(ordered = TRUE) %>% forcats::fct_rev()) %>% 
  left_join(data.frame(age_cat = c("(0,20]", "(20,40]", "(40,66]"), 
                       age_cat_label = c("[-20,0)", "[-40,-20)", "[-66,-40)") %>% factor(ordered = TRUE, levels = c("[-20,0)", "[-40,-20)", "[-66,-40)") %>% rev)))

table(latcat$lat_cat)
table(latcat$age_cat)

```


```{r}
lat_spatial_gradient_2 = ggplot(lat.windows_all %>% 
                                  pivot_longer(cols = c(w1, w5), values_to = "pal.lat", names_to = "window_bound" )  %>% 
                                  mutate(age_bin = forcats::fct_rev(age_bin)), 
                                aes(x = pal.lat, y = FAVA, 
                                    color = data, 
                                    group = paste0(window_index, age_bin, data, FAVA))) + 
  geom_vline(xintercept = 0, color ="grey", linewidth = 1.5) +
  geom_vline(xintercept = c(-30, 30), color ="grey", linewidth = 0.5) +
  geom_line(linewidth = 1, alpha=0.5) + 
  theme_bw() + scale_color_manual(values = data_pal, name = "Data") + 
  ggh4x::facet_manual(~ age_bin_label, design = design) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  theme(legend.position = c(0.92, 0.18), #legend.title = element_blank(),
        legend.background = element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  geom_point(data = lat.windows_all%>% 
               mutate(age_bin = forcats::fct_rev(age_bin))%>% 
               pivot_longer(cols = c(w1, w5), values_to = "pal.lat", names_to = "window_bound" )  %>%
               filter(window_bound == "w1"), size = 0.6, alpha = 0.8)+ 
  geom_line(aes(group = data), data = lat.windows_all%>% 
              mutate(age_bin = forcats::fct_rev(age_bin))%>% 
              pivot_longer(cols = c(w1, w5), values_to = "pal.lat", names_to = "window_bound" )  %>%
              filter(window_bound == "w1"), linewidth = 0.5, alpha = 0.8) + 
  xlab("Paleolatitude")

box_data_2 = ggplot(latcat, aes(x = lat_cat, y = FAVA, fill = data, color = data)) + geom_boxplot(alpha=0.3, outlier.alpha = 1) + 
  # ggpubr::stat_compare_means(comparisons = list(c("Southern", "Equatorial"), 
  #                                               c("Equatorial", "Northern"), 
  #                                               c("Southern", "Northern"))) +
  scale_fill_manual(values = data_pal, name = "Data") + 
  scale_color_manual(values = data_pal, name = "Data") + 
  theme_bw() + 
  facet_wrap(~age_cat_label, ncol = 1) + 
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = -0,vjust = 0),
        legend.position = c(0.55, 0.52))  +
  ggpubr::stat_compare_means(comparisons = list(c("Southern", "Equatorial"),
                                                c("Equatorial", "Northern"), 
                                                c("Southern", "Northern")), 
                             aes(label = ..p.signif..),
                             label.y = c(0.2, 0.25, 0.32)) + 
  ylim(0,0.36)

panels2 = wrap_plots(lat_spatial_gradient_2, box_data_2+ theme(legend.position = "none"), widths = c(3,1)) + plot_annotation(tag_levels = "A") & ylab("Spatial FAVA")
panels2

# ggsave("../Figures/lat_space_gradient_20_sample_threshold.png", panels2, width = 30, height = 18, scale = 0.3)
```

## statistics
```{r}
wilcox.test(filter(latcat, age_cat_label == "[-20,0)", lat_cat == "Equatorial")$FAVA, 
            filter(latcat, age_cat_label == "[-20,0)", lat_cat == "Southern")$FAVA,
            alternative = "less")

wilcox.test(filter(latcat, age_cat_label == "[-20,0)", lat_cat == "Equatorial")$FAVA, 
            filter(latcat, age_cat_label == "[-20,0)", lat_cat == "Northern")$FAVA,
            alternative = "less")

wilcox.test(filter(latcat, age_cat_label == "[-66,-40)", lat_cat == "Equatorial")$FAVA, 
            filter(latcat, age_cat_label == "[-66,-40)", lat_cat == "Southern")$FAVA,
            alternative = "greater")

wilcox.test(filter(latcat, age_cat_label == "[-66,-40)", lat_cat == "Equatorial")$FAVA, 
            filter(latcat, age_cat_label == "[-66,-40)", lat_cat == "Northern")$FAVA,
            alternative = "greater")


```



# TEMPORAL STABILITY

```{r}
# ------------------------------------------------------------------------------
# FILTER DATA SETS SO THAT EACH LAT BIN CONTAINS AT LEAST 10 YEAR BINS 
species_relab_5my_5deg_filtered = species_relab_5my_5deg %>%
  filter(lat_bin %in% 
           sort(unique(species_relab_5my_5deg$lat_bin))[
             table(species_relab_5my_5deg$lat_bin) >= 10]) 
ecogroup_relab_5my_5deg_filtered = ecogroup_relab_5my_5deg %>%
  filter(lat_bin %in% 
           sort(unique(species_relab_5my_5deg$lat_bin))[
             table(species_relab_5my_5deg$lat_bin) >= 10]) 
morphogroup_relab_5my_5deg_filtered = morphogroup_relab_5my_5deg %>%
  filter(lat_bin %in% 
           sort(unique(species_relab_5my_5deg$lat_bin))[
             table(species_relab_5my_5deg$lat_bin) >= 10]) 

species_age.windows = 
  FAVA::window_fava(relab_matrix = species_relab_5my_5deg_filtered,
                    window_size = 4,
                    K = 335,
                    group = "lat_bin",
                    time = "age_lower")

ecogroup_age.windows = 
  FAVA::window_fava(relab_matrix = ecogroup_relab_5my_5deg_filtered,
                    window_size = 4,
                    K = 18,
                    group = "lat_bin",
                    time = "age_lower")

morphogroup_age.windows = 
  FAVA::window_fava(relab_matrix = morphogroup_relab_5my_5deg_filtered,
                    window_size = 4,
                    K = 19,
                    group = "lat_bin",
                    time = "age_lower")


age.windows_all = morphogroup_age.windows$window_data %>%
  transmute(group, window_index, w1, w2, w3, w4, morphogroup = FAVA) %>% 
  left_join(ecogroup_age.windows$window_data %>% 
              transmute(group, window_index, w1, w2, w3, w4, ecogroup = FAVA)) %>% 
  left_join(species_age.windows$window_data %>% 
              transmute(group, window_index, w1, w2, w3, w4, species = FAVA)) %>%
  pivot_longer(cols = c(morphogroup, ecogroup, species), 
               names_to = "data", values_to = "FAVA")  %>% 
  pivot_longer(cols = c(w1, w2, w3, w4), names_to = "position", values_to = "mya")

age.windows_all$group = factor(age.windows_all$group, ordered=TRUE, levels = unique(morphogroup_relab_5my_5deg_filtered$lat_bin))

age.windows_all_diversity =
  age.windows_all %>% 
  transmute(lat_bin = group, window_index, age_lower = mya, data, position, FAVA) %>%
  left_join(diversity_long %>%
              mutate(lat_bin = factor(lat_bin, ordered = TRUE,
                                      levels = unique(morphogroup_relab_5my_5deg_filtered$lat_bin)))) %>% 
  group_by(lat_bin, lat_lower, window_index, data, FAVA) %>% 
  summarize(mean_diversity = mean(diversity), age_lower = min(-age_lower), age_upper = max(-age_lower))


ggplot(age.windows_all_diversity, aes(x = mean_diversity, y = FAVA)) + 
  theme_bw() + 
  geom_point(aes(color = lat_lower)) +
  scale_color_gradientn(colors = RColorBrewer::brewer.pal(11, "Spectral"), 
                        limits = c(-65,65), 
                        name = "Paleo\nlatitude") + 
  ylab("Temporal FAVA") + 
  geom_smooth(method = "lm", color="black") + 
  ggpubr::stat_cor(label.y = 0.31) + 
  facet_wrap(~data) + 
  xlab("Mean Gini-Simpson diversity in window")


lat.stab.grad.panels = ggplot(age.windows_all %>% 
                                mutate(data = stringr::str_to_title(data)))+ 
  geom_smooth(method = "lm", aes(x = mya, y = FAVA), linewidth = 0.3, color = "black")  + 
  geom_line(aes(x = mya, y = FAVA, 
                color = data, 
                group = paste0(window_index, group, data, FAVA)),
            linewidth = 1, alpha=0.6) + theme_bw() + 
  ggh4x::facet_grid2(data~group, 
                     strip = ggh4x::strip_themed(text_y=lapply(data_pal, function(col) element_text(color = col, face = "bold"))))+ 
  theme(legend.position = "none", strip.background = element_blank()) + 
  scale_x_reverse(breaks = c(60, 30, 0))+ 
  scale_color_manual(values = data_pal %>% `names<-`(c("Ecogroup", "Morphogroup", "Species")), guide="none") + 
  xlab("Million years ago") + 
  ylab("Temporal FAVA")
lat.stab.grad.panels

# ggsave("../Figures/lat_stab_grad_slopes_5my.png", lat.stab.grad.panels, width = 41, height = 12, scale = 0.3)


# Slopes for species
species_nested_age.windows <- species_age.windows$window_data %>% 
  pivot_longer(cols = w1:w4, names_to = "index", values_to = "mya") %>% 
  transmute(pal.lat = group, FAVA, mya) %>%
  nest(data = -pal.lat) %>%
  mutate(pal.lat = pal.lat %>% stringr::str_split_i(pattern = c("[\\[,\\]]+"), 2) %>% as.numeric)

species_slopes_by_lat <- species_nested_age.windows %>%
  mutate(model = map(data, ~lm(FAVA ~ mya, data = .)))  %>%
  mutate(results = map(model, tidy)) %>%
  unnest(results)  %>% filter(term == "mya") %>% 
  transmute(pal.lat, slope=-estimate, p.value, data = "species")
# ^ I use the negative of the slope here because time is going backwards


# Slopes for ecogroups
ecogroup_nested_age.windows <- ecogroup_age.windows$window_data %>% 
  pivot_longer(cols = w1:w4, names_to = "index", values_to = "mya") %>% 
  transmute(pal.lat = group, FAVA, mya) %>%
  nest(data = -pal.lat) %>%
  mutate(pal.lat = pal.lat %>% stringr::str_split_i(pattern = c("[\\[,\\]]+"), 2) %>% as.numeric)

ecogroup_slopes_by_lat <- ecogroup_nested_age.windows %>%
  mutate(model = map(data, ~lm(FAVA ~ mya, data = .)))  %>%
  mutate(results = map(model, tidy)) %>%
  unnest(results)  %>% filter(term == "mya") %>% 
  transmute(pal.lat, slope=-estimate, p.value, data = "ecogroup")
# ^ I use the negative of the slope here because time is going backwards


# Slopes for morphogroups
morphogroup_nested_age.windows <- morphogroup_age.windows$window_data %>% 
  pivot_longer(cols = w1:w4, names_to = "index", values_to = "mya") %>% 
  transmute(pal.lat = group, FAVA, mya) %>%
  nest(data = -pal.lat) %>%
  mutate(pal.lat = pal.lat %>% stringr::str_split_i(pattern = c("[\\[,\\]]+"), 2) %>% as.numeric)

morphogroup_slopes_by_lat <- morphogroup_nested_age.windows %>%
  mutate(model = map(data, ~lm(FAVA ~ mya, data = .)))  %>%
  mutate(results = map(model, tidy)) %>%
  unnest(results)  %>% filter(term == "mya") %>% 
  transmute(pal.lat, slope=-estimate, p.value, data = "morphogroup")
# ^ I use the negative of the slope here because time is going backwards

all_slopes_by_lat = rbind(ecogroup_slopes_by_lat, 
                          morphogroup_slopes_by_lat, 
                          species_slopes_by_lat)


# Fit quadratic and abs models to each data set 
quadratic_model_species <- lm(slope ~ pal.lat + I(pal.lat^2), data = species_slopes_by_lat)
quadratic_model_ecogroup <- lm(slope ~ pal.lat + I(pal.lat^2), data = ecogroup_slopes_by_lat)
quadratic_model_morphogroup <- lm(slope ~ pal.lat + I(pal.lat^2), data = morphogroup_slopes_by_lat)

summary(quadratic_model_species)
summary(quadratic_model_ecogroup)
summary(quadratic_model_morphogroup)


slopes_plot = ggplot(all_slopes_by_lat %>% mutate(data = stringr::str_to_title(data)), 
                     aes(x = pal.lat, y = slope, shape=data,
                         fill=data, color = data)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) + 
  stat_smooth(method = "glm", formula = y ~ x + I(x^2), alpha=0.15)+ 
  geom_point(size=3, alpha=0.75) + 
  scale_shape_manual(values = c(21, 22, 24), name = "Data")+
  # geom_point(size=2, aes(color = data)) + 
  xlab("Paleo latitude") + 
  ylab("[change in tFAVA] /\n[change in time (Myr)]") +
  theme_bw()+ 
  scale_x_continuous(breaks = seq(-60,60,10))+ 
  scale_fill_manual(values = data_pal %>%
                      `names<-`(stringr::str_to_title(names(data_pal))), 
                    name = "Data") + 
  scale_color_manual(values = data_pal %>%
                       `names<-`(stringr::str_to_title(names(data_pal))), 
                     name = "Data") +
  ylim(-0.005, 0.005)

slopes_plot
```

What in the world is going on with the species diversity vs temporal FAVA plot? 0.97 correlation??

```{r}
species = colnames(species_relab_5my_5deg[,-c(1:6)])

gamma.species.compositions = age.windows_all %>% 
  filter(data == "species") %>%
  transmute(lat_bin = group, window_index, age_lower = mya, position, FAVA) %>% 
  distinct %>%
  left_join(species_relab_5my_5deg %>% 
              mutate(lat_bin = factor(lat_bin, ordered=TRUE, 
                                      levels = unique(morphogroup_relab_5my_5deg_filtered$lat_bin)))) %>% 
  group_by(lat_bin, window_index, FAVA) %>% 
  summarize(age_lower = min(-age_upper), across(all_of(species), mean))

species_all_diversities = age.windows_all_diversity %>% filter(data == "species") %>% data.frame %>%
  mutate(gamma_diversity = apply(gamma.species.compositions[,-c(1:4)], 1, 
                                 function(row) 1 - sum(row^2))) %>% 
  mutate(fst_est = (gamma_diversity - mean_diversity)/gamma_diversity)


ggplot(species_all_diversities, 
       aes(x = mean_diversity, y = fst_est, color = gamma_diversity)) + 
  geom_smooth(method = "lm", color= "grey") +
  geom_point() + 
  scale_color_viridis_c() + 
  geom_line(data = 
              expand.grid(mean_diversity = seq(0.5, 1, 0.01), 
                          gamma_diversity = c(0.8, .865, 0.9, 0.92, 0.95, 0.97)) %>%
              mutate(fst_est = (gamma_diversity -
                                  mean_diversity)/gamma_diversity), 
            aes(group = gamma_diversity)) + 
  ylim(0,0.4) + 
  xlab("mean alpha diversity") + 
  ylab("unweighted FAVA") + 
  theme_bw() + 
  geom_abline(intercept = 1, slope = -1)

species_all_diversities$gamma_diversity %>% summary()

summary(lm(FAVA ~ mean_diversity, data = species_all_diversities))


```






What if I make the bins larger so that I can eliminate fewer of them?  

```{r}
count_threshold = 20

# These are the current bins
ggplot(triton, aes(x = age, y = pal.lat)) + geom_point(alpha = 0.05) + theme_bw() + 
  geom_vline(xintercept = c(seq(0,60,5), 66), color = "red") + 
  geom_hline(yintercept = c(-76, seq(-70,80,5), 88), color = "red")

# These are the proposed new bins: 
# only consider paleo latitude between +/- 60
ggplot(triton, aes(x = age, y = pal.lat)) + geom_point(alpha = 0.05) + theme_bw() + 
  geom_vline(xintercept = c(seq(0,60,5), 66), color = "red") + 
  geom_hline(yintercept = c(rev(seq(0,-75,-10)), seq(10,88,10)), color = "red") + 
  ylim(-60,60)







# EVERYTHING BELOW HERE IS INCOMPLETE






# Make a table of species counts for each age_bin/lat_bin combo
species_abundances_5my_7deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  transmute(species, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(rev(seq(0,-75,-7)), seq(7,88,7))), 
            abundance)  %>%
  group_by(age_bin, lat_bin, species) %>%
  summarise(abundance = sum(abundance)) %>%
  pivot_wider(names_from = species, 
              values_from = abundance, 
              values_fill = 0) %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))

# Remove the 19 age/lat combos with counts < 20
species_abundances_5my_7deg = species_abundances_5my_7deg[rowSums(species_abundances_5my_7deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
species_relab_5my_5deg = species_abundances_5my_5deg
species_relab_5my_5deg[,-c(1:6)] = species_abundances_5my_5deg[,-c(1:6)] /rowSums(species_abundances_5my_5deg[,-c(1:6)])



sampling_effort = species_abundances_5my_5deg[,c(1:6)] %>% 
  data.frame %>%
  mutate(total_abundance = rowSums(species_abundances_5my_5deg[,-c(1:6)]),
         age_bin = factor(age_bin, ordered = TRUE, levels = levels(species_abundances_5my_5deg$age_bin) %>% rev))


# Make a table of ecogroup counts for each age_bin/lat_bin combo
ecogroup_abundances_5my_5deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  left_join(ecogroup) %>%
  transmute(ecogroup = `Ecogroup(s)`, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(-76, seq(-70,80,5), 88)), 
            abundance)  %>%
  group_by(age_bin, lat_bin, ecogroup) %>%
  summarise(abundance = sum(abundance)) %>%
  filter(ecogroup !="") %>%
  pivot_wider(names_from = ecogroup, 
              values_from = abundance, 
              values_fill = 0)  %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))


# Remove the 15 age/lat combos with counts < 5
ecogroup_abundances_5my_5deg = ecogroup_abundances_5my_5deg[rowSums(ecogroup_abundances_5my_5deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
ecogroup_relab_5my_5deg = ecogroup_abundances_5my_5deg
ecogroup_relab_5my_5deg[,-c(1:6)] = ecogroup_abundances_5my_5deg[,-c(1:6)] /rowSums(ecogroup_abundances_5my_5deg[,-c(1:6)])




# Make a table of morphogroup counts for each age_bin/lat_bin combo
morphogroup_abundances_5my_5deg = triton %>% 
  filter(`Macro.micro` == "Macroperforate") %>%
  left_join(ecogroup) %>%
  transmute(morphogroup = Morphogroup, 
            age_bin = cut(age, breaks = c(seq(0,60,5), 66)), 
            lat_bin = cut(pal.lat, breaks =c(-76, seq(-70,80,5), 88)), 
            abundance)  %>%
  group_by(age_bin, lat_bin, morphogroup) %>%
  summarise(abundance = sum(abundance)) %>%
  filter(morphogroup !="") %>%
  pivot_wider(names_from = morphogroup, 
              values_from = abundance, 
              values_fill = 0) %>%
  mutate(
    age_lower = as.numeric(str_extract(as.character(age_bin), "-?\\d+\\.?\\d*")),
    age_upper = as.numeric(str_extract(as.character(age_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = age_bin
  ) %>%
  mutate(
    lat_lower = as.numeric(str_extract(as.character(lat_bin), "-?\\d+\\.?\\d*")),
    lat_upper = as.numeric(str_extract(as.character(lat_bin), "(?<=,)\\s*-?\\d+\\.?\\d*")), 
    .after = lat_bin
  ) %>% 
  mutate(age_bin = forcats::fct_rev(age_bin))


# Remove the 15 age/lat combos with counts < 5
morphogroup_abundances_5my_5deg = morphogroup_abundances_5my_5deg[rowSums(morphogroup_abundances_5my_5deg[,-c(1:6)])>=count_threshold,]

# Normalize rows to generate relative abundances
morphogroup_relab_5my_5deg = morphogroup_abundances_5my_5deg
morphogroup_relab_5my_5deg[,-c(1:6)] = morphogroup_abundances_5my_5deg[,-c(1:6)] /rowSums(morphogroup_abundances_5my_5deg[,-c(1:6)])
```

```{r}
gamma = c(0.001, 0.05, seq(0.1,1,0.05))

alpha_bar = seq(0,1,0.00001)

expand_grid(gamma, alpha_bar) %>%
  filter(gamma > alpha_bar) %>%
  mutate(FAVA = 1 - alpha_bar/gamma) %>% 
  ggplot(aes(x = alpha_bar, y = FAVA, color = gamma)) + 
  geom_line(aes(group = gamma), linewidth = 2, lineend = "round") + 
  scale_color_viridis_c(limits = c(0,1), option = "turbo") + 
  theme_bw() + 
  theme(legend.position = c(0.85, 0.7))
```

